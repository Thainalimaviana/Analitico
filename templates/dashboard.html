<link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h1 class="titulo-tomorrow">Painel Geral de ProduÃ§Ã£o</h1>

<div class="filtro-dashboard">
    <form method="GET" class="form-filtro">
        <div class="botoes-filtro">
            <button name="periodo" value="mes_atual" class="btn-filtro">MÃªs Atual</button>
            <button name="periodo" value="ultimo_mes" class="btn-filtro">Ãšltimo MÃªs</button>
            <button name="periodo" value="ultima_semana" class="btn-filtro">Ãšltima Semana</button>
            <button name="periodo" value="hoje" class="btn-filtro">Hoje</button>
            <button name="periodo" value="tudo" class="btn-filtro">Tudo</button>
        </div>

        <div class="seletor-datas">
            <label>Ou selecione intervalo:</label>

            <div class="input-data">
                <input type="date" name="inicio">
            </div>

            <span>atÃ©</span>

            <div class="input-data">
                <input type="date" name="fim">
            </div>

            <button type="submit" class="btn-filtrar">Filtrar</button>
        </div>
    </form>
</div>

<div class="cards-dashboard">
    <div class="card verde">
        <h3>Valor Equivalente</h3>
        <p class="valor">R$ {{ "{:,.2f}".format(total_eq or 0) }}</p>
    </div>

    <div class="card azul">
        <h3>Valor Original</h3>
        <p class="valor">R$ {{ "{:,.2f}".format(total_or or 0) }}</p>
    </div>

    <div class="card amarelo">
        <h3>Propostas</h3>
        <p class="valor">{{ total_propostas }}</p>
    </div>

    <div class="card cinza">
        <h3>Falta para Meta</h3>
        <p class="valor">R$ {{ "{:,.2f}".format(falta_meta or 0) }}</p>
    </div>
</div>

<div class="container-graficos">

    <div class="grafico-rosquinha">
        <h3>Comparativo de ProduÃ§Ã£o</h3>
        <div class="canvas-wrapper">
            <canvas id="graficoComparativo"></canvas>
        </div>
    </div>

    <div class="grafico-ranking">
        <h3>Top 3 Consultores do MÃªs</h3>

        <div class="podium">
            {% set ouro = ranking[0] if ranking|length > 0 else None %}
            {% set prata = ranking[1] if ranking|length > 1 else None %}
            {% set bronze = ranking[2] if ranking|length > 2 else None %}

            {% if prata %}
            <div class="coluna prata">
                <div class="medalha">ðŸ¥ˆ</div>
                <div class="barra prata-bar">
                    <span class="valor">{{ "{:,.0f}".format(prata[1]) }}</span>
                </div>
                <p class="nome">{{ prata[0] }}</p>
            </div>
            {% endif %}

            {% if ouro %}
            <div class="coluna ouro">
                <div class="medalha">ðŸ¥‡</div>
                <div class="barra ouro-bar">
                    <span class="valor">{{ "{:,.0f}".format(ouro[1]) }}</span>
                </div>
                <p class="nome">{{ ouro[0] }}</p>
            </div>
            {% endif %}

            {% if bronze %}
            <div class="coluna bronze">
                <div class="medalha">ðŸ¥‰</div>
                <div class="barra bronze-bar">
                    <span class="valor">{{ "{:,.0f}".format(bronze[1]) }}</span>
                </div>
                <p class="nome">{{ bronze[0] }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="grafico-bancos-container">
        <h3>DistribuiÃ§Ã£o de Propostas por Banco</h3>
        <div class="canvas-wrapper">
            <canvas id="graficoBancos"></canvas>
        </div>

        <table class="tabela-bancos">
            <thead>
                <tr>
                    <th>Banco</th>
                    <th>Propostas</th>
                    <th>Valor Total (R$)</th>
                </tr>
            </thead>
            <tbody>
                {% for b in bancos_dados %}
                <tr>
                    <td>{{ b[0] }}</td>
                    <td>{{ b[1] }}</td>
                    <td>R$ {{ "{:,.2f}".format(b[2]) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let graficoComparativo, graficoRanking;

    function renderizarGraficos() {
        const legendaCor = document.body.classList.contains("dark-mode") ? "#fff" : "#222";

        if (graficoComparativo) graficoComparativo.destroy();
        if (graficoRanking) graficoRanking.destroy();

        graficoComparativo = new Chart(document.getElementById('graficoComparativo'), {
            type: 'doughnut',
            data: {
                labels: ['Valor Equivalente', 'Falta para Meta'],
                datasets: [{
                    data: [{{ total_eq }}, {{ falta_meta }}],
            backgroundColor: ['#00c853', '#424242'],
            borderWidth: 0
        }]
    },
    options: {
        cutout: '70%',
            plugins: {
            legend: {
                position: 'bottom',
                    labels: {
                    color: getComputedStyle(document.body).getPropertyValue('--cor-texto').trim() || '#222'
                }

            },
            tooltip: {
                backgroundColor: 'rgba(20, 20, 20, 0.92)',
                    borderColor: 'rgba(255, 255, 255, 0.15)',
                        borderWidth: 1,
                            padding: 10,
                                titleColor: '#fff',
                                    bodyColor: '#fff',
                                        titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 },
                displayColors: false,
                    callbacks: {
                    title: function(ctx) {
                        return ctx[0].label;
                    },
                    label: function(ctx) {
                        const valor = ctx.parsed;
                        const formatado = new Intl.NumberFormat("pt-BR", {
                            style: "currency",
                            currency: "BRL"
                        }).format(valor);
                        return [
                            'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
                            `ðŸ’¸ ${formatado}`
                        ];
                    }
                }
            }
        },
        maintainAspectRatio: false,
            responsive: true
    }
});

    const nomes = {{ ranking| map(attribute = 0) | list | tojson }};
    const valores = {{ ranking| map(attribute = 1) | list | tojson }};

    graficoRanking = new Chart(document.getElementById('graficoRanking'), {
        type: 'bar',
        data: {
            labels: nomes,
            datasets: [{
                data: valores,
                backgroundColor: ['#FFD700', '#C0C0C0', '#CD7F32'],
                borderRadius: 12
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: legendaCor } },
                x: { ticks: { color: legendaCor } }
            },
            maintainAspectRatio: false,
            responsive: true
        }
    });
    }

    renderizarGraficos();

    function atualizarDashboard() {
        fetch(window.location.href)
            .then(res => res.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");

                const novosCards = doc.querySelector(".cards-dashboard");
                if (novosCards) {
                    document.querySelector(".cards-dashboard").innerHTML = novosCards.innerHTML;
                }

                const novoRanking = doc.querySelector(".grafico-ranking");
                if (novoRanking) {
                    document.querySelector(".grafico-ranking").innerHTML = novoRanking.innerHTML;
                }

                const novoEq = parseFloat(doc.querySelector(".card.verde .valor").innerText.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                const novaMeta = parseFloat(doc.querySelector(".card.cinza .valor").innerText.replace(/[^\d,]/g, '').replace(',', '.')) || 0;

                if (graficoComparativo) {
                    graficoComparativo.data.datasets[0].data = [novoEq, novaMeta];
                    graficoComparativo.update();
                }

                if (typeof aplicarFormatacaoBRL === "function") {
                    aplicarFormatacaoBRL();
                }
            })
            .catch(err => console.error("Erro ao atualizar dashboard:", err));
    }

    setInterval(atualizarDashboard, 300000);
    setTimeout(atualizarDashboard, 10000);

</script>
<script>
    const bancos = {{ bancos_dados | map(attribute = 0) | list | tojson }};
    const propostas = {{ bancos_dados | map(attribute = 1) | list | tojson }};
    const valores = {{ bancos_dados | map(attribute = 2) | list | tojson }};

    const legendaCor = document.body.classList.contains("dark-mode") ? "#fff" : "#222";

    const formatarBRL = (v) => new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(v);

    new Chart(document.getElementById('graficoBancos'), {
        type: 'bar',
        data: {
            labels: bancos,
            datasets: [{
                label: 'Propostas',
                data: propostas,
                backgroundColor: '#00b848',
                borderRadius: 10
            }]
        },
        options: {
            indexAxis: 'x',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(20, 20, 20, 0.92)',
                    borderColor: 'rgba(255, 255, 255, 0.15)',
                    borderWidth: 1,
                    padding: 10,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    displayColors: false,
                    callbacks: {
                        title: function (ctx) {
                            return ctx[0].label;
                        },
                        label: function (ctx) {
                            const i = ctx.dataIndex;
                            const qtd = propostas[i];
                            const valor = valores[i];
                            return [
                                'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
                                `ðŸ“Š ${qtd} proposta${qtd > 1 ? 's' : ''}`,
                                `ðŸ’° ${formatarBRL(valor)}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: legendaCor, font: { weight: '600' } },
                    grid: { color: 'rgba(255,255,255,0.08)' }
                },
                y: {
                    beginAtZero: true,
                    ticks: { color: legendaCor },
                    grid: { color: 'rgba(255,255,255,0.08)' }
                }
            },
            maintainAspectRatio: false,
            responsive: true
        }
    });
</script>


{% endblock %}